<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Memorybook留言本</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width:600px;margin:auto; }
    textarea { width:100%; height:120px; }
  </style>
</head>
<body>
  <h2>Leave a message</h2>
  <p>Share a message for Qiuyi. (Photos optional)</p>

  <input id="boardId" placeholder="Your Name你的名字" style="width:100%;margin-bottom:8px;" />
  <textarea id="text" placeholder="Your message你的留言"></textarea>
  <div style="margin:8px 0;">
    <input type="file" id="file" accept="image/*" />
  </div>
  <button id="submit">Submit</button>
  <p id="status"></p>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';


   
    // 填入你的 Supabase URL 与 ANON KEY（部署前替换/或用环境注入在部署步骤）
    const SUPABASE_URL = "https://gqfnjqbpwibadwjvvwft.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxZm5qcWJwd2liYWR3anZ2d2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTIxMTEsImV4cCI6MjA3NjcyODExMX0.nInGbzyEDkYORebmDdvJn7HjLK0IpeEQj0hboB7puwM";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function uploadImage(file) {
      if (!file) return null;
      const ext = file.name.split('.').pop();
      // 放到 public 文件夹下
      const fileName = `public/img_${Date.now()}.${ext}`;
      const { data, error } = await sb.storage
        .from('guestbook-images')
        .upload(fileName, file, { cacheControl: '3600', upsert: false });
      if (error) {
        console.error('Storage upload error:', error);
        return null;
      }
      // 返回 public URL
      return `${SUPABASE_URL}/storage/v1/object/public/guestbook-images/${fileName}`;
    }



    document.getElementById('submit').onclick = async () => {
      const boardId = document.getElementById('boardId').value.trim();
      const text = document.getElementById('text').value.trim();
      const fileInput = document.getElementById('file');
      if (!boardId) { alert("Please ask owner for Board ID."); return; }
      document.getElementById('status').innerText = "Uploading...";
      let image_url = null;
      if (fileInput.files.length > 0) {
        image_url = await uploadImage(fileInput.files[0]);
      }
      const { error } = await sb
        .from('messages')
        .insert([{ board_id: boardId, content: text, image_url }]);
      if (error) {
        document.getElementById('status').innerText = "Submit failed.";
        console.error(error);
      } else {
        document.getElementById('status').innerText = "Thanks! Your message is submitted.";
        document.getElementById('text').value = "";
        fileInput.value = "";
      }
    };
  </script>
</body>
</html>
